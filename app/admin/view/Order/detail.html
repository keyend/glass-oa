{extend name="base" /}
{block name="resources"}
<style>
    .page-member-form .layui-tab-content {
        padding: 15px 15px 0 0!important;
    }
    .page-member-form .layui-card {
        padding-bottom: 5px;
    }
    .layui-number {
        width: 60px; 
        display: inline-block; 
        text-align: center; 
        margin-right: 6px;
    }
    .layui-number:not(:first-of-type) {
        margin-left: 6px;
    }
    .order-delivery .layui-elem-quote.title span {
        margin-right: 12px;
    }
    .order-delivery .layui-elem-quote.title span.layui-badge {
        margin-left: -12px;
    }
    .order-delivery .layui-number {
        text-align: left;
        width: 100%;
    }
    .layui-btn-fill {
        padding: 0px!important;
        margin: -1px;
    }
    .layui-btn-fill .layui-btn {
        width: 100%;
    }
    .layui-bg-green, .bg-green {
        background-color: rgb(1, 129, 1)!important;
    }
    .layui-bg-green1 {
        background-color: rgb(93, 122, 78)!important;
    }
    .layui-bg-dark {
        background-color: rgb(119, 120, 119)!important;
    }
    .layui-bg-red {
        background-color: rgb(175, 1, 1)!important;
    }
    .layui-table {
        width: 100%!important;
    }
    .detail-title {
        position: relative;
    }
    .detail-title .layui-btn {
        position: absolute;
        top: -5px;
        right: 30px;
    }
</style>
{/block}
{block name="body"}
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body" style="padding: 15px 10px!important;">
            <div class="layui-tab layui-tab-brief">
                <ul class="layui-tab-title">
                    <li><a href="{:url('order')}">全部订单</a></li>
                    <li class="layui-this"><a>订单明细</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="layui-card order-delivery">
        <form class="layui-card-body layui-form" method="POST" enctype="application/x-www-form-urlencoded">
            <blockquote class="layui-elem-quote title">
                <p class="detail-title">
                    <span>订单号：{$order.trade_no}</span>
                    <span>客户名称：{$order.customer}</span>
                    {if $order.is_trash}
                    <span class="layui-badge layui-bg-dark">已作废</span>
                    {/if}
                    <span>录单人员：{$order.user.username}</span>
                    <span>总金额：{$order.order_money}</span>
                    <span>优惠金额：{$order.discount_money}</span>
                    <span>实际金额：{:number_format($order['order_money'] - $order['discount_money'], 2, '.', '')}</span>
                    <span>已付金额：{$order.pay_money}</span>
                    {if $order.status < 2}
                    <button class="layui-btn layui-btn-sm" lay-filter="edit" lay-submit style="display: none;">编辑订单</button>
                    {/if}
                </p>
            </blockquote>
            <table id="parse-table-demo" lay-filter="parse-table-demo">
                <thead> 
                    <tr>
                        <th lay-data="{field:'id', hide: true}">#</th>
                        <th lay-data="{field:'print_label', hide: true}"></th>
                        <th lay-data="{field:'is_delete', hide: true}"></th>
                        <th lay-data="{field:'category', sort:true, templet: '#col-category'}">品类名称</th>
                        <th lay-data="{field:'craft', width:160, sort:true, templet: '#col-craft'}">工艺</th>
                        <th lay-data="{field:'width', width:120, sort:true, templet: '#col-width'}">宽(mm)</th>
                        <th lay-data="{field:'height', width:120, sort:true, templet: '#col-height'}">高(mm)</th>
                        <th lay-data="{field:'area', width:120, sort:true}">面积(m²)</th>
                        <th lay-data="{field:'unitprice', width:120, sort:true}">单价(元)</th>
                        <th lay-data="{field:'manual_money', width:120, sort:true, templet: '#col-manual'}">加工费(元)</th>
                        <th lay-data="{field:'num', width:100, sort:true}">数量</th>
                        <th lay-data="{field:'deductnum', width:100, sort:true}">已配送</th>
                        <th lay-data="{field:'operator', width:180, templet: '#col-operator'}"></th>
                    </tr> 
                </thead> 
                <tbody id="order-content">
                    {foreach $order.goods as $goods}
                    <tr id="row_{$goods.id}">
                        <td>{$goods.id}</td>
                        <td>{$goods.print_label}</td>
                        <td>{$goods.is_delete}</td>
                        <td>{$goods.category}</td>
                        <td>{$goods.craft}</td>
                        <td>{$goods.width|floatval}</td>
                        <td>{$goods.height|floatval}</td>
                        <td>{$goods.area}</td>
                        <td>{$goods.unitprice}</td>
                        <td>{$goods.manual_money}</td>
                        <td>{$goods.num}</td>
                        <td>{$goods.deductnum}</td>
                        <td></td>
                    </tr>
                    {/foreach}
                </tbody>
                <tfoot>
                    <tr style="background-color:#f7f7f7;">
                        <td colspan="9">
                            <span>总计应收：</span>
                            <span>{$order.order_money}元</span>
                            <span> + </span>
                            <span>{$order.manual_money}元</span>
                            <span> = </span>
                            <span>{:round($order.order_money + $order.manual_money, 2)}元</span>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="9" class="layui-btn-fill">
                            <input type="hidden" name="delivery_data" id="delivery_data_{$order.id}" value='{:json_encode($order, JSON_UNESCAPED_UNICODE)}' />
                            <button type="button" class="layui-btn layui-btn-normal" lay-filter="form1" lay-submit>打印所有标签</button>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </form>
    </div>
</div>

<script type="text/html" id="col-category">
    {{ d.category }}
    {{# if(d.print_label > 0) { }}
    <span class="layui-badge" title="已打印{{ d.print_label }}次">{{ d.print_label }}</span>
    {{# } }}
</script>

<script type="text/html" id="col-craft">
    {{ d.craft }}
</script>

<script type="text/html" id="col-width">
    {{ d.width }}
</script>

<script type="text/html" id="col-height">
    {{ d.height }}
</script>

<script type="text/html" id="col-manual">
    {{ d.manual_money }}
</script>

<script type="text/html" id="col-operator">
    <div class="layui-btn-group">
        <button type="button" class="layui-btn layui-btn-xs layui-btn-normal" lay-filter="print" data-id="{{ d.id }}" data-orderid="{{ d.order_id }}">打印标签</button>
    </div>
</script>
{/block}
{block name="scripts"}
<script>
    var goodsList = {:json_encode($order["goods"], JSON_UNESCAPED_UNICODE)};

    layui.config({ base: '/static/admin/' }).use(['form', 'laytpl', 'table', 'util'], function(){
        var $ = layui.$, goodsNums = {}, form = layui.form, util = layui.util, table = layui.table;

        function getPrintArr(data, id) {
            var result = {};
            id = id || 0,
            result.ids = [];
            result.data = [],
            data.goods.forEach(v => {
                if (id == v.id || id == 0) {
                    result.data.push({
                        KH: data.customer,
                        DD: data.out_trade_no,
                        MC: v.category,
                        GG: parseFloat(v.width) + "宽X" + parseFloat(v.height) + "高=" + v.num + "/" + data.order_num,
                        GY: v.craft,
                        XH: v.remark
                    }),
                    result.ids.push(v.id);
                }
            });
            return result;
        }

        function requestPrint(rds) {
            var loader = parent.layer.load(2, { shade: ['#fff', .3] }), ds = {
                data: rds.data
            };
            $.ajax({
                url: 'http://127.0.0.1:31580/Printer',
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(ds),
                processData: false,
                contentType: "application/json; charset=utf-8",
                complete: function(xhr) {
                    parent.layer.close(loader);
                    var r = JSON.parse(xhr.responseText);
                    if (r.ret == 0) {
                        parent.layer.msg("SUCCESS");
                        $.post("{:url('orderGoodsPrint')}", {ids: rds.ids});
                    } else {
                        parent.layer.alert(r.msg)
                    }
                }
            });
        }

        form.on('submit(form1)', function(obj) {
            var field = JSON.parse(obj.field.delivery_data) ,data = getPrintArr(field);
            requestPrint(getPrintArr(field));
        }),

        $('button[lay-filter="print"]').on("click", function(e) {
            var that = $(this), field = JSON.parse($("#delivery_data_" + that.data("orderid")).val());
            requestPrint(getPrintArr(field, that.data("id")));
        }),

        table.init('parse-table-demo', {
            done(res) {
                console.log(res);
            }
        }),
        table.on('edit(parse-table-demo)', function(obj) {
            console.log(obj);
            // 更新单元格
        });
    })
</script>
{/block}