{extend name="base" /}
{block name="resources"}
<style>
    .page-member-form .layui-tab-content {
        padding: 15px 15px 0 0!important;
    }
    .page-member-form .layui-card {
        padding-bottom: 5px;
    }
    .layui-number {
        width: 60px; 
        display: inline-block; 
        text-align: center; 
        margin-right: 6px;
    }
    .layui-number:not(:first-of-type) {
        margin-left: 6px;
    }
    .order-delivery .layui-elem-quote.title span {
        margin-right: 12px;
    }
    .order-delivery .layui-number {
        text-align: left;
        width: 100%;
    }
    .layui-btn-fill {
        padding: 0px!important;
        margin: -1px;
    }
    .layui-btn-fill .layui-btn {
        width: 100%;
    }
    .layui-table {
        width: 100%!important;
    }
    .text-center {
        text-align: center!important;
    }
</style>
{/block}
{block name="body"}
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body" style="padding: 15px 10px!important;">
            <div class="layui-tab layui-tab-brief">
                <ul class="layui-tab-title">
                    <li><a href="{:url('order')}">全部订单</a></li>
                    <li class="layui-this"><a>订单配送</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="layui-card order-delivery">
        <form class="layui-card-body layui-form" method="POST" enctype="application/x-www-form-urlencoded">
            <blockquote class="layui-elem-quote title">
                <p>
                    <button type="button" class="layui-btn layui-btn-default layui-btn-sm" style="margin-right: 12px;" onclick="history.back();">
                        <i class="layui-icon layui-icon-return"></i>返回
                    </button>
                    <span>订单号：{$order.trade_no}</span>
                    <span>客户名称：{$order.customer}</span>
                    <span>录单人员：{$order.user.username}</span>
                    <span>总金额：{$order.order_money}</span>
                    <span>优惠金额：{$order.discount_money}</span>
                    <span>实际金额：{:number_format($order['order_money'] - $order['discount_money'], 2, '.', '')}</span>
                    <span>已付金额：{$order.pay_money}</span>
                </p>
            </blockquote>
            <table class="layui-table">
                <colgroup>
                    <col width="50">
                    <col width="160">
                    <col width="160">
                    <col>
                    <col width="120">
                    <col width="120">
                    {if $order.status < 2}
                    <col width="120">
                    {/if}
                </colgroup>
                <thead>
                    <tr class="layui-table-header">
                        <th class="text-center">#</th>
                        <th>品类名称</th>
                        <th>工艺</th>
                        <th>规格</th>
                        <th>加工费</th>
                        <th>已送数量</th>
                        {if $order.status < 2}
                        <th>本次配送数量</th>
                        {/if}
                    </tr> 
                </thead> 
                <tbody id="order-content">
                    {foreach $order.goods as $key => $goods}
                    <tr>
                        <td class="text-center">{$key+1}</td>
                        <td>{$goods.category}</td>
                        <td>{$goods.craft}</td>
                        <td>{$goods.width|floatval}mm X {$goods.height|floatval}mm X {$goods.num} = {:round($goods.area*$goods.num,2)}m² X {$goods.unitprice}元 = {$goods.order_money}元</td>
                        <td>{$goods.manual}元</td>
                        <td>{$goods.deductnum}</td>
                        {if $order.status < 2}
                        <td>
                            {if $goods.max > 0}
                            <input type="number" name="num[{$goods.id}]" data-id="{$goods.id}" data-max="{$goods.max}" lay-filter="delivery-num" placeholder="0" class="layui-input layui-number" value="{$goods.max}" />
                            {else}
                            配送完成
                            {/if}
                        </td>
                        {/if}
                    </tr>
                    {/foreach}
                </tbody>
                <tfoot>
                    <tr style="background-color:#f7f7f7;">
                        <td colspan="4">总计：</td>
                        <td><span>{$order.deductnum}</span></td>
                        {if $order.status < 2}
                        <td><span id="totalNum">--.--</span></td>
                        {/if}
                        <td></td>
                    </tr>
                    {if $order.status < 2}
                    <tr>
                        <td colspan="10" class="layui-btn-fill">
                            <button type="button" class="layui-btn" lay-filter="form1" lay-submit>生成配送单</button>
                        </td>
                    </tr>
                    {/if}
                </tfoot>
            </table>
        </form>
    </div>

    {foreach $order.delivery as $delivery}
    <div class="layui-card order-delivery">
        <form class="layui-card-body layui-form">
            <blockquote class="layui-elem-quote title">
                <p>
                    <span>配送号：{$delivery.trade_no}</span>
                    <span>配送时间：{$delivery.create_time}</span>
                    <span>配送数量：{$delivery.delivery_num}</span>
                    <span>配送金额：{$delivery.delivery_money}</span>
                    <span>加工金额：{$delivery.manual_money}</span>
                </p>
            </blockquote>
            <table class="layui-table">
                <colgroup>
                    <col width="160">
                    <col width="160">
                    <col>
                    <col width="120">
                    <col width="120">
                </colgroup>
                <thead> 
                    <tr class="layui-table-header">
                        <th>品类名称</th>
                        <th>工艺</th>
                        <th>规格</th>
                        <th>加工费</th>
                        <th>配送数量</th>
                    </tr> 
                </thead> 
                <tbody id="order-content">
                    {foreach $delivery.goods as $goods}
                    <tr>
                        <td>{$goods.category}</td>
                        <td>{$goods.craft}</td>
                        <td>{$goods.width|floatval}mm X {$goods.height|floatval}mm X {$goods.num} = {:round($goods.area*$goods.num,2)}m² X {$goods.unitprice}元 = {$goods.delivery_money}元</td>
                        <td>{$goods.manual_money}元</td>
                        <td>{$goods.num}</td>
                    </tr>
                    {/foreach}
                </tbody>
                <tfoot>
                    <tr style="background-color:#f7f7f7;">
                        <td colspan="2">
                            {if checkAccess("orderPrint")}
                            <input type="checkbox" name="manual" value="1" data-id="{$delivery.id}" lay-filter="delivery" title="打印价格" lay-skin="tag" />
                            {/if}
                            <span style="margin-left: 6px;">总计应收：{:round($delivery.delivery_money + $delivery.manual_money, 2)}元</span>
                        </td>
                        <td><span>{$delivery.delivery_money}元</span></td>
                        <td><span>{$delivery.manual_money}元</span></td>
                        <td><span>{$delivery.delivery_num}</span></td>
                    </tr>
                    {if checkAccess("orderPrint")}
                    <tr>
                        <td colspan="5" class="layui-btn-fill">
                            <input type="hidden" name="delivery_data" value='{:json_encode($delivery, JSON_UNESCAPED_UNICODE)}' />
                            <button type="button" class="layui-btn" lay-filter="print" lay-submit>打印配送单</button>
                        </td>
                    </tr>
                    {/if}
                </tfoot>
            </table>
        </form>
    </div>
    {/foreach}

</div>
{/block}
{block name="scripts"}
<script>
    var printUrl = "{:url('orderPrint')}";
    var defaultPrompt = "{$option.order_printrm}";
    var isPrintWarn = "{:conf('auxiliary.delivery_warnpnt')}";

    layui.config({ base: '/static/admin/' }).use(['form', 'laytpl', 'table'], function(){
        var $ = layui.$, goodsNums = {}, form = layui.form;

        $('input[lay-filter="delivery-num"]').on("input propertychange", function() {
            var id = this.getAttribute("data-id")
            , num = parseInt(this.value)
            , total = 0
            , max = parseInt(this.getAttribute("data-max"));
            num = isNaN(num) ? 0 : num;
            num > max && (num = max, this.value = num),
            num < 0 && (num = 0, this.value = num),
            goodsNums[id] = num;
            Object.values(goodsNums).forEach(v => total += v);
            document.getElementById("totalNum").innerText = total;
        }),

        form.on('submit(form1)', function(obj) {
            if (Object.values(goodsNums).length < 1) {
                return false;
            }

            parent.layer.prompt({title: '核算无误进行生成配送单？', formType: 2, value: defaultPrompt}, function(text, i){
                parent.layer.close(i),
                obj.field["remark"] = text,
                ns.silent(location.href, obj.field, res => {
                    if (res.code == 0) {
                        if (isPrintWarn == "1") {
                            parent.layer.confirm('已成功生成配送单，是否立即打印配送单?', {icon: 3, title:'提示'}, function(i){
                                parent.layer.close(i),
                                requestPrint(getPrintArr(res.data))
                            }, function(i) {
                                parent.layer.close(i),
                                setTimeout(() => location.reload(), 100)
                            })
                        } else {
                            setTimeout(() => location.reload(), 100)
                        }
                    } else {
                        layer.alert(res.message)
                    }
                })
            });
        }),

        form.on('submit(print)', function(obj) {
            var data = JSON.parse(obj.field.delivery_data);
            window.open(printUrl + '?id=' + data.id + '&manual=' + (obj.field.manual || 0))
        }),

        $('input[lay-filter="delivery-num"]').trigger("input");

        function getTimeDate(date) {
            date = date.split(' ');
            return date[0]
        }

        function getPrintArr(data, id) {
            var result = {
                KH: data.order.customer,
                DZ: data.order.address,
                DD: data.order.trade_no,
                RQ: getTimeDate(data.create_time),
                MX: 0,
                data: []
            }, total_money;
            id = id || 0,
            result.data = [],
            data.goods.forEach(v => {
                total_money = parseFloat(v.manual_money) + parseFloat(v.delivery_money),
                result.data.push({
                    name: v.category + v.craft,
                    w: parseFloat(v.width),
                    h: parseFloat(v.height),
                    num: v.num,
                    area: v.area,
                    price: v.unitprice,
                    fee: v.manual,
                    total: total_money.toFixed(2),
                    desc: v.remark
                })
            });
            return result;
        }

        function requestPrint(data) {
            var loader = parent.layer.load(2, { shade: ['#fff', .3] });
            $.ajax({
                url: 'http://127.0.0.1:31580/Printer2',
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(data),
                processData: false,
                contentType: "application/json; charset=utf-8",
                fail: function(e) {
                    console.log(e);
                },
                complete: function(xhr) {
                    parent.layer.close(loader);
                    try {
                        var r = JSON.parse(xhr.responseText);
                        if (r.ret == 0) {
                            $.post("{:url('orderDeliveryPrint')}", {ids: delivery.id}),
                            parent.layer.msg("SUCCESS");
                        } else {
                            parent.layer.alert(r.msg)
                        }
                    } catch (e) {
                        console.log(e),
                        parent.layer.msg("打印失败：请检查打印服务", { icon: 2 })
                    }
                }
            });
        }
    })
</script>
{/block}